<div class="container">
  <h2>Logical Vector to Graph Scheme</h2>
  
  <div class="input-group">
    <div class="input-row">
      <label for="inputVector">Logical Vector:</label>
      <input style="width: 400px;" [(ngModel)]="inputVector"
             placeholder="Enter logical vector (e.g., 0001, 0110, 0111, 1001, ...)"
             id="inputVector"
             (input)="onVectorChange()"
             (keydown.enter)="onConvert()" />
    </div>
    
    <div class="input-row" *ngIf="showSizeInputs">
      <label for="rows">Rows:</label>
      <input type="number" [(ngModel)]="rows" id="rows" min="1" max="32" />
      
      <label for="cols">Columns:</label>
      <input type="number" [(ngModel)]="cols" id="cols" min="1" max="32" />
    </div>
    
    <div class="input-row">
      <!-- <ng-container *ngIf="showResult && hasIsolatedVertices">
        <label><input type="checkbox" [(ngModel)]="hideIsolated" (change)="computeVisibleNodes()" /> Hide isolated vertices</label>
      </ng-container> -->
      <button (click)="onConvert()">Convert</button>
    </div>
  </div>
  
  <div *ngIf="error" class="error-message">{{ error }}</div>

  <div *ngIf="showResult && !error"
       class="result-container">
    
    <svg [attr.width]="svgSize"
         [attr.height]="svgSize">
      
      <!-- Овальные контуры для разделов двудольного графа -->
      <ng-container *ngIf="bipartiteLayout">
        <ng-container *ngIf="getPartitionOvals() as ovalCoords">
          <!-- Левая часть (раздел U) -->
          <ellipse [attr.cx]="ovalCoords.left.x"
                   [attr.cy]="ovalCoords.left.y"
                   [attr.rx]="ovalCoords.left.width / 2"
                   [attr.ry]="ovalCoords.left.height / 2"
                   fill="none"
                   stroke="#2196F3"
                   stroke-width="2"
                   stroke-dasharray="5,5"
                   opacity="0.7" />
          
          <!-- Правая часть (раздел V) -->
          <ellipse [attr.cx]="ovalCoords.right.x"
                   [attr.cy]="ovalCoords.right.y"
                   [attr.rx]="ovalCoords.right.width / 2"
                   [attr.ry]="ovalCoords.right.height / 2"
                   fill="none"
                   stroke="#4CAF50"
                   stroke-width="2"
                   stroke-dasharray="5,5"
                   opacity="0.7" />
          
          <!-- Подписи разделов -->
          <text [attr.x]="ovalCoords.left.x"
                [attr.y]="ovalCoords.left.y - ovalCoords.left.height / 2 - 10"
                text-anchor="middle"
                font-size="16"
                font-weight="bold"
                fill="#2196F3">U</text>
          
          <text [attr.x]="ovalCoords.right.x"
                [attr.y]="ovalCoords.right.y - ovalCoords.right.height / 2 - 10"
                text-anchor="middle"
                font-size="16"
                font-weight="bold"
                fill="#4CAF50">V</text>
        </ng-container>
      </ng-container>
      
      <!-- Nodes (только круги) -->
      <g *ngFor="let idx of visibleNodeIndices; let _i = index">
        <ng-container *ngIf="nodes[idx] as node">
        <circle [attr.cx]="nodeCoords[idx].x"
                [attr.cy]="nodeCoords[idx].y"
                r="18"
                [attr.fill]="bipartiteLayout ? (isNodeLeft(idx) ? '#E3F2FD' : '#E8F5E8') : nodeColors[idx % nodeColors.length]"
                [attr.stroke]="bipartiteLayout ? (isNodeLeft(idx) ? '#2196F3' : '#4CAF50') : '#1976d2'"
                stroke-width="3" />
        <!-- Белый круг под текст -->
        <circle [attr.cx]="nodeCoords[idx].x"
                [attr.cy]="nodeCoords[idx].y"
                r="11"
                fill="#fff" />
        </ng-container>
      </g>
      
      <!-- Edges (arrows) -->
      <ng-container *ngFor="let from of nodes; let i = index">
        <ng-container *ngFor="let to of nodes; let j = index">
          <ng-container *ngIf="inputVector[i * nodes.length + j] === '1'">
            <!-- Петля (только для не-двудольных графов и когда есть рефлексивные отношения) -->
            <ng-container *ngIf="i === j && !bipartiteLayout && hasReflexiveRelations">
              <ng-container *ngIf="nodes.length === 2">
                <!-- Квадратная петля для 0 (слева) -->
                <path *ngIf="i === 0"
                  [attr.d]="'M ' + (nodeCoords[0].x - 18) + ' ' + (nodeCoords[0].y + 6) + ' h -18 v -18 h 18'"
                  stroke="#1976d2" stroke-width="3" fill="none" marker-end="url(#arrowSmall)" />
                <!-- Квадратная петля для 1 (справа) -->
                <path *ngIf="i === 1"
                  [attr.d]="'M ' + (nodeCoords[1].x + 18) + ' ' + (nodeCoords[1].y - 6) + ' h 18 v 18 h -18'"
                  stroke="#1976d2" stroke-width="3" fill="none" marker-end="url(#arrowSmall)" />
              </ng-container>
              <ng-container *ngIf="nodes.length !== 2">
                <!-- Новая петля: выраженная, сбоку от круга -->
                <path [attr.d]="getExpressiveLoopPath(nodeCoords[i].x, nodeCoords[i].y, i, nodes.length, 28)"
                      stroke="#1976d2" stroke-width="3" fill="none" marker-end="url(#arrowSmall)" />
              </ng-container>
            </ng-container>
            <!-- Обычная стрелка -->
            <ng-container *ngIf="i !== j">
              <line [attr.x1]="getEdgePoint(nodeCoords[i].x, nodeCoords[i].y, nodeCoords[j].x, nodeCoords[j].y, 18).x"
                    [attr.y1]="getEdgePoint(nodeCoords[i].x, nodeCoords[i].y, nodeCoords[j].x, nodeCoords[j].y, 18).y"
                    [attr.x2]="getEdgePoint(nodeCoords[j].x, nodeCoords[j].y, nodeCoords[i].x, nodeCoords[i].y, 18).x"
                    [attr.y2]="getEdgePoint(nodeCoords[j].x, nodeCoords[j].y, nodeCoords[i].x, nodeCoords[i].y, 18).y"
                    marker-end="url(#arrow)"
                    [attr.stroke]="bipartiteLayout ? '#666' : '#1976d2'"
                    stroke-width="2.5" />
            </ng-container>
          </ng-container>
        </ng-container>
      </ng-container>
      
      <!-- Текст поверх -->
      <g *ngFor="let idx of visibleNodeIndices">
        <text [attr.x]="nodeCoords[idx].x"
              [attr.y]="nodeCoords[idx].y + 6"
              text-anchor="middle"
              font-size="14"
              [attr.fill]="bipartiteLayout ? (isNodeLeft(idx) ? '#2196F3' : '#4CAF50') : '#1976d2'"
              style="pointer-events: none; font-weight: bold;">{{ nodes[idx] }}</text>
      </g>
      
      <defs>
        <marker id="arrow" markerWidth="6" markerHeight="6" refX="6" refY="3" orient="auto" markerUnits="strokeWidth">
          <path d="M0,0 L6,3 L0,6 Z" fill="#666" />
        </marker>
        <marker id="arrowSmall" markerWidth="4" markerHeight="4" refX="4" refY="2" orient="auto" markerUnits="strokeWidth">
          <path d="M0,0 L4,2 L0,4 Z" fill="#1976d2" />
        </marker>
      </defs>
    </svg>
    
    <!-- Right side info -->
    <div class="right-panel">
      
      <!-- Matrix Representation -->
      <div class="truth-table">
        <div style="font-weight: bold; margin-bottom: 8px; text-align: center;">Matrix Representation ({{rows}}×{{cols}})</div>
        <table>
          <tr>
            <th>Row\Col</th>
            <th *ngFor="let col of [].constructor(cols); let j = index">{{ getBinaryIndexUnified(j) }}</th>
          </tr>
          <tr *ngFor="let row of [].constructor(rows); let i = index">
            <td style="font-weight: bold;">{{ getBinaryIndexUnified(i) }}</td>
            <td *ngFor="let col of [].constructor(cols); let j = index">
              {{ inputVector[i * cols + j] === '1' ? '1' : '' }}
            </td>
          </tr>
        </table>
      </div>
      
      <!-- Reflexive Relations Info -->
      <div class="reflexive-info">
        <div class="info-label">Reflexive Relations:</div>
        <div class="info-item">
          <strong>{{ hasReflexiveRelations ? 'Yes' : 'No' }}</strong>
          <small *ngIf="hasReflexiveRelations">(All vertices have self-loops)</small>
          <small *ngIf="!hasReflexiveRelations">(2×2 matrices have no self-loops)</small>
        </div>
      </div>
      
      <!-- Graph Info -->
      <div class="graph-info">
        <div class="info-label">Graph Structure:</div>
        <div class="info-item">
          <strong>{{nodes.length}} vertices</strong>
          <small>{{rows}}×{{cols}} regular</small>
        </div>
      </div>
      
      <!-- Bipartite Info -->
      <div *ngIf="isBipartite" class="bipartite-info">
        <div class="partition-label">Partitions:</div>
        <div class="partition-item">
          <span class="partition-color left-partition"></span>
          <strong>U:</strong> {{ leftPartition.join(', ') }}
        </div>
        <div class="partition-item">
          <span class="partition-color right-partition"></span>
          <strong>V:</strong> {{ rightPartition.join(', ') }}
        </div>
        <div class="bipartite-note">
          <small>Note: Self-loops are hidden for bipartite graphs</small>
        </div>
      </div>
    </div>
  </div>
</div>