<div class="container">
  <h2>Logical Vector to Graph Scheme</h2>
  <input [(ngModel)]="inputVector"
         placeholder="Enter logical vector (e.g., 0001, 0110, 0111, 1001, ...)"
         id="inputVector"
         (keydown.enter)="onConvert()" />
  <div><button (click)="onConvert()">Convert</button></div>
  <div *ngIf="error" class="error-message">{{ error }}</div>

  <div *ngIf="showResult && !error"
       class="result-container">
    
    <svg [attr.width]="svgSize"
         [attr.height]="svgSize">
      
      <!-- Овальные контуры для разделов двудольного графа -->
      <ng-container *ngIf="bipartiteLayout">
        <ng-container *ngIf="getPartitionOvals() as ovalCoords">
          <!-- Левая часть (раздел U) -->
          <ellipse [attr.cx]="ovalCoords.left.x"
                   [attr.cy]="ovalCoords.left.y"
                   [attr.rx]="ovalCoords.left.width / 2"
                   [attr.ry]="ovalCoords.left.height / 2"
                   fill="none"
                   stroke="#2196F3"
                   stroke-width="2"
                   stroke-dasharray="5,5"
                   opacity="0.7" />
          
          <!-- Правая часть (раздел V) -->
          <ellipse [attr.cx]="ovalCoords.right.x"
                   [attr.cy]="ovalCoords.right.y"
                   [attr.rx]="ovalCoords.right.width / 2"
                   [attr.ry]="ovalCoords.right.height / 2"
                   fill="none"
                   stroke="#4CAF50"
                   stroke-width="2"
                   stroke-dasharray="5,5"
                   opacity="0.7" />
          
          <!-- Подписи разделов -->
          <text [attr.x]="ovalCoords.left.x"
                [attr.y]="ovalCoords.left.y - ovalCoords.left.height / 2 - 10"
                text-anchor="middle"
                font-size="16"
                font-weight="bold"
                fill="#2196F3">U</text>
          
          <text [attr.x]="ovalCoords.right.x"
                [attr.y]="ovalCoords.right.y - ovalCoords.right.height / 2 - 10"
                text-anchor="middle"
                font-size="16"
                font-weight="bold"
                fill="#4CAF50">V</text>
        </ng-container>
      </ng-container>
      
      <!-- Nodes (только круги) -->
      <g *ngFor="let node of nodes; let i = index">
        <circle [attr.cx]="nodeCoords[i].x"
                [attr.cy]="nodeCoords[i].y"
                r="18"
                [attr.fill]="bipartiteLayout ? (isNodeLeft(i) ? '#E3F2FD' : '#E8F5E8') : nodeColors[i % nodeColors.length]"
                [attr.stroke]="bipartiteLayout ? (isNodeLeft(i) ? '#2196F3' : '#4CAF50') : '#1976d2'"
                stroke-width="3" />
        <!-- Белый круг под текст -->
        <circle [attr.cx]="nodeCoords[i].x"
                [attr.cy]="nodeCoords[i].y"
                r="11"
                fill="#fff" />
      </g>
      
      <!-- Edges (arrows) -->
      <ng-container *ngFor="let from of nodes; let i = index">
        <ng-container *ngFor="let to of nodes; let j = index">
          <ng-container *ngIf="inputVector[i * nodes.length + j] === '1'">
            <!-- Петля (только для не-двудольных графов) -->
            <ng-container *ngIf="i === j && !bipartiteLayout">
              <ng-container *ngIf="nodes.length === 2">
                <!-- Квадратная петля для 0 (слева) -->
                <path *ngIf="i === 0"
                  [attr.d]="'M ' + (nodeCoords[0].x - 18) + ' ' + (nodeCoords[0].y + 6) + ' h -18 v -18 h 18'"
                  stroke="#1976d2" stroke-width="3" fill="none" marker-end="url(#arrowSmall)" />
                <!-- Квадратная петля для 1 (справа) -->
                <path *ngIf="i === 1"
                  [attr.d]="'M ' + (nodeCoords[1].x + 18) + ' ' + (nodeCoords[1].y - 6) + ' h 18 v 18 h -18'"
                  stroke="#1976d2" stroke-width="3" fill="none" marker-end="url(#arrowSmall)" />
              </ng-container>
              <ng-container *ngIf="nodes.length !== 2">
                <!-- Новая петля: выраженная, сбоку от круга -->
                <path [attr.d]="getExpressiveLoopPath(nodeCoords[i].x, nodeCoords[i].y, i, nodes.length, 28)"
                      stroke="#1976d2" stroke-width="3" fill="none" marker-end="url(#arrowSmall)" />
              </ng-container>
            </ng-container>
            <!-- Обычная стрелка -->
            <ng-container *ngIf="i !== j">
              <line [attr.x1]="getEdgePoint(nodeCoords[i].x, nodeCoords[i].y, nodeCoords[j].x, nodeCoords[j].y, 18).x"
                    [attr.y1]="getEdgePoint(nodeCoords[i].x, nodeCoords[i].y, nodeCoords[j].x, nodeCoords[j].y, 18).y"
                    [attr.x2]="getEdgePoint(nodeCoords[j].x, nodeCoords[j].y, nodeCoords[i].x, nodeCoords[i].y, 18).x"
                    [attr.y2]="getEdgePoint(nodeCoords[j].x, nodeCoords[j].y, nodeCoords[i].x, nodeCoords[i].y, 18).y"
                    marker-end="url(#arrow)"
                    [attr.stroke]="bipartiteLayout ? '#666' : '#1976d2'"
                    stroke-width="2.5" />
            </ng-container>
          </ng-container>
        </ng-container>
      </ng-container>
      
      <!-- Текст поверх -->
      <g *ngFor="let node of nodes; let i = index">
        <text [attr.x]="nodeCoords[i].x"
              [attr.y]="nodeCoords[i].y + 6"
              text-anchor="middle"
              font-size="14"
              [attr.fill]="bipartiteLayout ? (isNodeLeft(i) ? '#2196F3' : '#4CAF50') : '#1976d2'"
              style="pointer-events: none; font-weight: bold;">{{ node }}</text>
      </g>
      
      <defs>
        <marker id="arrow" markerWidth="6" markerHeight="6" refX="6" refY="3" orient="auto" markerUnits="strokeWidth">
          <path d="M0,0 L6,3 L0,6 Z" fill="#666" />
        </marker>
        <marker id="arrowSmall" markerWidth="4" markerHeight="4" refX="4" refY="2" orient="auto" markerUnits="strokeWidth">
          <path d="M0,0 L4,2 L0,4 Z" fill="#1976d2" />
        </marker>
      </defs>
    </svg>
    
    <!-- Right side info -->
    <div class="right-panel">
      
      <!-- Truth Table -->
      <div class="truth-table">
        <div style="font-weight: bold; margin-bottom: 8px; text-align: center;">Truth Table</div>
        <table>
          <tr>
            <th>Input</th>
            <th *ngFor="let node of nodes">{{ node }}</th>
          </tr>
          <tr *ngFor="let from of nodes; let i = index">
            <td style="font-weight: bold;">{{ from }}</td>
            <td *ngFor="let to of nodes; let j = index">
              {{ inputVector[i * nodes.length + j] }}
            </td>
          </tr>
        </table>
      </div>
      
      <!-- Bipartite Info -->
      <div *ngIf="isBipartite" class="bipartite-info">
        <div class="partition-label">Partitions:</div>
        <div class="partition-item">
          <span class="partition-color left-partition"></span>
          <strong>U:</strong> {{ leftPartition.join(', ') }}
        </div>
        <div class="partition-item">
          <span class="partition-color right-partition"></span>
          <strong>V:</strong> {{ rightPartition.join(', ') }}
        </div>
        <div class="bipartite-note">
          <small>Note: Self-loops are hidden for bipartite graphs</small>
        </div>
      </div>
    </div>
  </div>
</div>